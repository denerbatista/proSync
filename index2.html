<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>ProSync - Jornada de Trabalho (Passo a Passo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-100 min-h-screen flex items-center justify-center">
    <div
      class="w-full max-w-3xl mx-3 my-6 bg-white shadow-2xl rounded-2xl p-5 sm:p-8 space-y-6"
    >
      <header class="space-y-2 text-center">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900">
          ProSync ‚Äì Jornada de Trabalho
        </h1>
        <p class="text-sm sm:text-base text-slate-600">
          Siga os passos para calcular automaticamente seus hor√°rios de trabalho,
          almo√ßo e banco/hora extra.
        </p>
      </header>

      <!-- Indicador de passos -->
      <nav class="flex items-center justify-center gap-3 sm:gap-6">
        <div class="flex items-center gap-2">
          <div
            id="stepBubble1"
            class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-blue-600 text-white"
          >
            1
          </div>
          <span class="hidden sm:inline text-sm font-medium text-slate-700"
            >Configura√ß√µes</span
          >
        </div>
        <div class="h-px w-8 sm:w-16 bg-slate-300"></div>
        <div class="flex items-center gap-2">
          <div
            id="stepBubble2"
            class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-slate-200 text-slate-600"
          >
            2
          </div>
          <span class="hidden sm:inline text-sm font-medium text-slate-700"
            >Entradas & sa√≠das</span
          >
        </div>
        <div class="h-px w-8 sm:w-16 bg-slate-300"></div>
        <div class="flex items-center gap-2">
          <div
            id="stepBubble3"
            class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-slate-200 text-slate-600"
          >
            3
          </div>
          <span class="hidden sm:inline text-sm font-medium text-slate-700"
            >Resultado</span
          >
        </div>
      </nav>

      <!-- PASSO 1: Configura√ß√µes -->
      <section
        id="step1"
        class="space-y-6 bg-slate-50 border border-slate-200 rounded-2xl p-4 sm:p-6"
      >
        <h2 class="text-xl font-semibold text-slate-800 mb-2">
          Passo 1 ‚Äì Configura√ß√µes b√°sicas
        </h2>
        <p class="text-sm text-slate-600 mb-4">
          Defina sua jornada, como quer tratar o hor√°rio de almo√ßo e, se quiser,
          informe hora extra ou banco de horas.
        </p>

        <div class="grid gap-5 md:grid-cols-3">
          <!-- Jornada -->
          <div class="flex flex-col gap-2">
            <label
              for="jornada"
              class="text-sm font-semibold text-slate-800 flex items-center justify-between"
            >
              Jornada de trabalho
              <span class="text-[11px] uppercase text-blue-600 font-bold"
                >obrigat√≥rio</span
              >
            </label>
            <input
              id="jornada"
              type="time"
              class="border rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
              value="08:12"
            />
            <p class="text-xs text-slate-500">
              Padr√£o: <strong>08:12</strong>. Use hh:mm (ex.: 07:30, 12:00).
            </p>
          </div>

          <!-- Almo√ßo (modo manual/autom√°tico) -->
          <div class="flex flex-col gap-2 md:col-span-2">
            <div class="flex items-center justify-between">
              <label
                class="text-sm font-semibold text-slate-800"
                for="almoco"
              >
                Hor√°rio de almo√ßo
              </label>
              <label class="flex items-center gap-2 text-xs text-slate-700">
                <input
                  id="chkAlmocoAuto"
                  type="checkbox"
                  class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                />
                <span>Calcular almo√ßo automaticamente</span>
              </label>
            </div>

            <!-- Grupo: almo√ßo manual -->
            <div id="almocoManualGroup" class="flex flex-col gap-1">
              <input
                id="almoco"
                type="time"
                class="border rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Informe a dura√ß√£o do almo√ßo"
              />
              <p class="text-xs text-slate-500">
                Informe a <strong>dura√ß√£o</strong> do almo√ßo (ex.: 01:48). Se
                preferir que o sistema calcule automaticamente, marque a op√ß√£o
                acima.
              </p>
            </div>

            <!-- Grupo: almo√ßo autom√°tico (1¬™ entrada / √∫ltima sa√≠da) -->
            <div
              id="almocoAutoGroup"
              class="grid grid-cols-1 sm:grid-cols-2 gap-3 hidden"
            >
              <div class="flex flex-col gap-1">
                <label
                  for="diaEntrada"
                  class="text-xs font-semibold text-slate-700"
                  >1¬™ entrada do dia</label
                >
                <input
                  id="diaEntrada"
                  type="time"
                  class="border rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex.: 07:30"
                />
              </div>
              <div class="flex flex-col gap-1">
                <label
                  for="diaSaida"
                  class="text-xs font-semibold text-slate-700"
                  >√öltima sa√≠da do dia</label
                >
                <input
                  id="diaSaida"
                  type="time"
                  class="border rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex.: 17:45"
                />
              </div>
              <p class="sm:col-span-2 text-xs text-slate-500">
                O ProSync vai usar a <strong>1¬™ entrada</strong> e a
                <strong>√∫ltima sa√≠da</strong> junto com a jornada para calcular
                automaticamente o tempo de almo√ßo.
              </p>
            </div>
          </div>

          <!-- Hora extra / Banco de horas -->
          <div class="flex flex-col gap-2 md:col-span-1">
            <label
              for="extra"
              class="text-sm font-semibold text-slate-800 flex items-center justify-between"
            >
              Hora extra / banco
              <span class="text-[11px] uppercase text-amber-600 font-bold"
                >opcional</span
              >
            </label>
            <input
              id="extra"
              type="text"
              class="border rounded-lg px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex.: 01:30 ou -00:45"
            />
            <p class="text-xs text-slate-500">
              Use <strong>positivo</strong> para hora extra (ex.: 01:00) e
              <strong>negativo</strong> para banco de horas (ex.: -00:30).
            </p>
          </div>
        </div>

        <div class="flex justify-end pt-4">
          <button
            id="btnNext1"
            class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-sm sm:text-base font-semibold shadow-md transition"
          >
            Pr√≥ximo passo
            <span>‚û°Ô∏è</span>
          </button>
        </div>
      </section>

      <!-- PASSO 2: Entradas e sa√≠das -->
      <section
        id="step2"
        class="space-y-6 bg-slate-50 border border-slate-200 rounded-2xl p-4 sm:p-6 hidden"
      >
        <h2 class="text-xl font-semibold text-slate-800 mb-2">
          Passo 2 ‚Äì Entradas e sa√≠das
        </h2>
        <p class="text-sm text-slate-600 mb-4">
          Ajuste seus hor√°rios de entrada e sa√≠da. Se voc√™ j√° informou 1¬™
          entrada e √∫ltima sa√≠da no passo anterior (modo autom√°tico), eles j√°
          aparecem aqui.
        </p>

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <div>
            <p class="text-sm text-slate-700 font-medium">
              Intervalos de trabalho
            </p>
            <p class="text-xs text-slate-500">
              Use os dois primeiros intervalos como base (manh√£ e tarde). Voc√™
              pode adicionar outros intervalos, se precisar.
            </p>
          </div>
          <button
            id="btnAdicionar"
            class="self-start sm:self-auto inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium px-4 py-2 rounded-full shadow-sm transition"
          >
            ‚ûï Adicionar intervalo
          </button>
        </div>

        <div class="overflow-x-auto border border-slate-200 rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th
                  class="px-3 sm:px-4 py-2 text-left font-semibold text-slate-700"
                >
                  #
                </th>
                <th
                  class="px-3 sm:px-4 py-2 text-left font-semibold text-slate-700"
                >
                  Entrada
                </th>
                <th
                  class="px-3 sm:px-4 py-2 text-left font-semibold text-slate-700"
                >
                  Sa√≠da
                </th>
                <th
                  class="px-3 sm:px-4 py-2 text-left font-semibold text-slate-700"
                >
                  A√ß√µes
                </th>
              </tr>
            </thead>
            <tbody id="tbodyIntervalos" class="divide-y divide-slate-100">
              <!-- Intervalo 1 (manh√£) -->
              <tr>
                <td class="px-3 sm:px-4 py-3 text-slate-700 font-semibold">1</td>
                <td class="px-3 sm:px-4 py-3">
                  <input
                    type="time"
                    class="entrada border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="08:00"
                  />
                </td>
                <td class="px-3 sm:px-4 py-3">
                  <input
                    type="time"
                    class="saida border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="12:00"
                  />
                </td>
                <td class="px-3 sm:px-4 py-3 text-[11px] text-slate-400">
                  (fixo)
                </td>
              </tr>

              <!-- Intervalo 2 (tarde) -->
              <tr>
                <td class="px-3 sm:px-4 py-3 text-slate-700 font-semibold">2</td>
                <td class="px-3 sm:px-4 py-3">
                  <input
                    type="time"
                    class="entrada border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="13:48"
                  />
                </td>
                <td class="px-3 sm:px-4 py-3">
                  <input
                    type="time"
                    class="saida border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="17:48"
                  />
                </td>
                <td class="px-3 sm:px-4 py-3 text-[11px] text-slate-400">
                  (fixo)
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-between pt-4">
          <button
            id="btnBack2"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm font-medium transition"
          >
            ‚¨ÖÔ∏è Voltar
          </button>
          <button
            id="btnNext2"
            class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-sm sm:text-base font-semibold shadow-md transition"
          >
            Ir para resultado
            <span>‚û°Ô∏è</span>
          </button>
        </div>
      </section>

      <!-- PASSO 3: Resultado -->
      <section
        id="step3"
        class="space-y-6 bg-slate-50 border border-slate-200 rounded-2xl p-4 sm:p-6 hidden"
      >
        <h2 class="text-xl font-semibold text-slate-800 mb-2">
          Passo 3 ‚Äì Resultado final
        </h2>
        <p class="text-sm text-slate-600 mb-3">
          Gere o c√°lculo completo e veja seus hor√°rios preenchidos de forma
          clara. Voc√™ pode voltar ao passo anterior para ajustar e gerar de
          novo.
        </p>

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <button
            id="btnBack3"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm font-medium transition"
          >
            ‚¨ÖÔ∏è Voltar para ajustes
          </button>

          <div class="flex gap-3">
            <button
              id="btnLimpar"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm font-medium transition"
            >
              üßπ Limpar hor√°rios
            </button>
            <button
              id="btnCalcular"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm sm:text-base font-semibold shadow-md transition"
            >
              ‚úÖ Gerar hor√°rios
            </button>
          </div>
        </div>

        <!-- Resumo -->
        <div
          id="resumoCard"
          class="hidden border border-emerald-200 rounded-2xl bg-emerald-50 p-4 sm:p-5 space-y-4"
        >
          <h3 class="text-lg font-semibold text-emerald-900">
            Resumo da jornada gerada
          </h3>
          <p id="resumoTexto" class="text-sm text-emerald-800"></p>

          <!-- Aqui vem os inputs finais com todos os hor√°rios -->
          <div
            id="listaHorarios"
            class="mt-2 text-sm bg-white/70 border border-emerald-100 rounded-xl p-3 space-y-3"
          ></div>

          <p class="text-xs text-emerald-700">
            Os hor√°rios acima tamb√©m est√£o preenchidos na tabela do Passo 2. Se
            quiser, volte, ajuste manualmente e gere novamente.
          </p>
        </div>

        <!-- Mensagens gerais -->
        <p id="mensagem" class="text-xs text-slate-600 italic"></p>
      </section>
    </div>

    <!-- Script interno -->
    <script>
      // Refer√™ncias gerais
      const tbody = document.getElementById("tbodyIntervalos");
      const btnAdicionar = document.getElementById("btnAdicionar");
      const btnCalcular = document.getElementById("btnCalcular");
      const btnLimpar = document.getElementById("btnLimpar");
      const msg = document.getElementById("mensagem");
      const resumoCard = document.getElementById("resumoCard");
      const resumoTexto = document.getElementById("resumoTexto");
      const listaHorarios = document.getElementById("listaHorarios");

      // Passos
      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      const stepBubble1 = document.getElementById("stepBubble1");
      const stepBubble2 = document.getElementById("stepBubble2");
      const stepBubble3 = document.getElementById("stepBubble3");
      const btnNext1 = document.getElementById("btnNext1");
      const btnNext2 = document.getElementById("btnNext2");
      const btnBack2 = document.getElementById("btnBack2");
      const btnBack3 = document.getElementById("btnBack3");

      // Almo√ßo UI
      const chkAlmocoAuto = document.getElementById("chkAlmocoAuto");
      const almocoManualGroup = document.getElementById("almocoManualGroup");
      const almocoAutoGroup = document.getElementById("almocoAutoGroup");

      // Campos de dia (auto)
      const diaEntradaInput = document.getElementById("diaEntrada");
      const diaSaidaInput = document.getElementById("diaSaida");

      let currentStep = 1;

      function setStep(step) {
        currentStep = step;

        step1.classList.toggle("hidden", step !== 1);
        step2.classList.toggle("hidden", step !== 2);
        step3.classList.toggle("hidden", step !== 3);

        function setBubble(el, active) {
          if (active) {
            el.className =
              "w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-blue-600 text-white";
          } else {
            el.className =
              "w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-slate-200 text-slate-600";
          }
        }

        setBubble(stepBubble1, step === 1);
        setBubble(stepBubble2, step === 2);
        setBubble(stepBubble3, step === 3);

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Alternar almo√ßo manual/autom√°tico
      function updateAlmocoMode() {
        const auto = chkAlmocoAuto.checked;
        if (auto) {
          almocoManualGroup.classList.add("hidden");
          almocoAutoGroup.classList.remove("hidden");
        } else {
          almocoManualGroup.classList.remove("hidden");
          almocoAutoGroup.classList.add("hidden");
        }
      }

      chkAlmocoAuto.addEventListener("change", updateAlmocoMode);
      updateAlmocoMode();

      // Fun√ß√µes utilit√°rias de tempo
      function parseTimeToMinutes(value) {
        if (!value) return null;
        const [h, m] = value.split(":").map(Number);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        return h * 60 + m;
      }

      function minutesToHHMM(mins) {
        mins = ((mins % (24 * 60)) + 24 * 60) % (24 * 60);
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
      }

      function minutesToSignedDuration(mins) {
        if (mins === 0) return "+00:00";
        const sign = mins < 0 ? "-" : "+";
        const abs = Math.abs(mins);
        const h = Math.floor(abs / 60);
        const m = abs % 60;
        return (
          sign + String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0")
        );
      }

      function getJornadaMinutes() {
        const jornadaInput = document.getElementById("jornada");
        const mins = parseTimeToMinutes(jornadaInput.value);
        if (mins === null || mins <= 0) {
          throw new Error("Informe uma jornada de trabalho v√°lida (hh:mm).");
        }
        return mins;
      }

      function isAlmocoAuto() {
        return chkAlmocoAuto.checked;
      }

      // Almo√ßo manual: pode ser null se campo vazio
      function getAlmocoMinutes() {
        const almocoInput = document.getElementById("almoco");
        if (!almocoInput.value) return null;
        const mins = parseTimeToMinutes(almocoInput.value);
        if (mins === null || mins <= 0) {
          throw new Error(
            "Informe uma dura√ß√£o de almo√ßo v√°lida (hh:mm) ou deixe em branco."
          );
        }
        return mins;
      }

      function getExtraMinutes() {
        const extraInput = document.getElementById("extra");
        const v = extraInput.value.trim();
        if (!v) return 0;
        const match = v.match(/^([+-])?(\d{1,2}):([0-5]\d)$/);
        if (!match) {
          throw new Error(
            "Hora extra/banco inv√°lida. Use o formato ¬±hh:mm (ex.: 01:30 ou -00:45)."
          );
        }
        const sign = match[1] === "-" ? -1 : 1;
        const h = Number(match[2]);
        const m = Number(match[3]);
        return sign * (h * 60 + m);
      }

      function showMessage(text, isError = false) {
        msg.textContent = text;
        msg.className =
          "text-xs italic " +
          (isError ? "text-red-600" : "text-emerald-700");
      }

      function clearMessage() {
        msg.textContent = "";
        msg.className = "text-xs text-slate-600 italic";
      }

      function renumerarLinhas() {
        const linhas = tbody.querySelectorAll("tr");
        linhas.forEach((tr, index) => {
          const tdIndex = tr.querySelector("td");
          if (tdIndex) tdIndex.textContent = index + 1;
        });
      }

      function adicionarLinha() {
        const linhas = tbody.querySelectorAll("tr").length;
        const index = linhas + 1;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 sm:px-4 py-3 text-slate-700 font-semibold">${index}</td>
          <td class="px-3 sm:px-4 py-3">
            <input
              type="time"
              class="entrada border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </td>
          <td class="px-3 sm:px-4 py-3">
            <input
              type="time"
              class="saida border rounded-lg px-3 py-2 w-28 sm:w-32 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </td>
          <td class="px-3 sm:px-4 py-3">
            <button
              type="button"
              class="btn-remover text-xs text-red-600 hover:text-red-800"
            >
              Remover
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      function limparHorarios() {
        const entradas = tbody.querySelectorAll(".entrada");
        const saidas = tbody.querySelectorAll(".saida");
        entradas.forEach((i) => (i.value = ""));
        saidas.forEach((i) => (i.value = ""));
        clearMessage();
        resumoCard.classList.add("hidden");
        resumoTexto.textContent = "";
        listaHorarios.innerHTML = "";
      }

      function renderResumoHorarios() {
        const linhas = Array.from(tbody.querySelectorAll("tr"));
        if (!linhas.length) return;

        listaHorarios.innerHTML = linhas
          .map((tr, idx) => {
            const entVal = tr.querySelector(".entrada").value || "";
            const saiVal = tr.querySelector(".saida").value || "";
            return `
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                <span class="text-xs sm:text-sm font-medium text-slate-700">
                  Intervalo ${idx + 1}
                </span>
                <div class="flex items-center gap-2">
                  <input
                    type="time"
                    value="${entVal}"
                    class="border rounded-lg px-3 py-1.5 text-sm bg-white"
                    readonly
                  />
                  <span class="text-xs text-slate-500">‚Üí</span>
                  <input
                    type="time"
                    value="${saiVal}"
                    class="border rounded-lg px-3 py-1.5 text-sm bg-white"
                    readonly
                  />
                </div>
              </div>
            `;
          })
          .join("");
      }

      function calcularAutomatico() {
        clearMessage();
        resumoCard.classList.add("hidden");
        resumoTexto.textContent = "";
        listaHorarios.innerHTML = "";

        let jornadaBaseMin;
        let almocoMin;
        let extraMin;

        try {
          jornadaBaseMin = getJornadaMinutes();
          extraMin = getExtraMinutes();

          if (isAlmocoAuto()) {
            almocoMin = null; // ser√° calculado depois se poss√≠vel
          } else {
            almocoMin = getAlmocoMinutes();
          }
        } catch (e) {
          showMessage(e.message, true);
          return;
        }

        const jornadaMin = jornadaBaseMin + extraMin;
        if (jornadaMin <= 0) {
          showMessage(
            "A jornada total (jornada base + hora extra/banco) ficou menor ou igual a zero.",
            true
          );
          return;
        }

        const rows = tbody.querySelectorAll("tr");
        if (rows.length < 2) {
          showMessage(
            "√â recomendado ter pelo menos 2 intervalos (manh√£ e tarde).",
            true
          );
          return;
        }

        const row1 = rows[0];
        const row2 = rows[1];

        const ent1Input = row1.querySelector(".entrada");
        const sai1Input = row1.querySelector(".saida");
        const ent2Input = row2.querySelector(".entrada");
        const sai2Input = row2.querySelector(".saida");

        let ent1 = parseTimeToMinutes(ent1Input.value);
        let sai1 = parseTimeToMinutes(sai1Input.value);
        let ent2 = parseTimeToMinutes(ent2Input.value);
        let sai2 = parseTimeToMinutes(sai2Input.value);

        // Se modo almo√ßo autom√°tico e ainda n√£o temos almocoMin,
        // tenta calcular a partir da 1¬™ entrada e √∫ltima sa√≠da
        if (isAlmocoAuto() && almocoMin === null && ent1 !== null && sai2 !== null) {
          const totalPresenca = sai2 - ent1;
          const almocoCalc = totalPresenca - jornadaMin;
          if (almocoCalc < 0) {
            showMessage(
              "Com essa jornada, a sa√≠da informada √© muito cedo (n√£o sobra tempo para almo√ßo). Ajuste a sa√≠da ou a jornada.",
              true
            );
            return;
          }
          almocoMin = almocoCalc;
          document.getElementById("almoco").value = minutesToHHMM(almocoMin);
        }

        const metadeJornada = Math.round(jornadaMin / 2);

        if (!ent1 && !sai2 && !sai1 && !ent2) {
          showMessage(
            "Informe pelo menos a primeira entrada OU a √∫ltima sa√≠da para calcular automaticamente.",
            true
          );
          return;
        }

        function ensureAlmoco() {
          if (almocoMin === null) {
            if (isAlmocoAuto()) {
              showMessage(
                "Para calcular o almo√ßo automaticamente, informe 1¬™ entrada e √∫ltima sa√≠da, ou desmarque a op√ß√£o de c√°lculo autom√°tico e informe a dura√ß√£o do almo√ßo.",
                true
              );
            } else {
              showMessage(
                "Informe a dura√ß√£o do almo√ßo (hh:mm) no Passo 1.",
                true
              );
            }
            return false;
          }
          return true;
        }

        // -------- NOVO: resolu√ß√£o alg√©brica quando APENAS 1 campo est√° em branco --------
        const flags = {
          ent1: ent1 === null,
          sai1: sai1 === null,
          ent2: ent2 === null,
          sai2: sai2 === null,
        };
        const missingKeys = Object.keys(flags).filter((k) => flags[k]);

        if (missingKeys.length === 1) {
          // precisa de almo√ßo conhecido
          if (!ensureAlmoco()) return;

          const missing = missingKeys[0];

          if (missing === "ent1") {
            // precisa de sai1, ent2, sai2
            if (sai1 !== null && ent2 !== null && sai2 !== null) {
              // Work = (sai1 - E1) + (sai2 - ent2)
              // => E1 = sai1 + sai2 - ent2 - Work
              ent1 = sai1 + sai2 - ent2 - jornadaMin;
            }
          } else if (missing === "sai1") {
            // precisa de ent1, ent2
            if (ent1 !== null && ent2 !== null) {
              // L = ent2 - sai1 => sai1 = ent2 - L
              sai1 = ent2 - almocoMin;
            }
          } else if (missing === "ent2") {
            // precisa de sai1
            if (sai1 !== null) {
              // L = ent2 - sai1 => ent2 = sai1 + L
              ent2 = sai1 + almocoMin;
            }
          } else if (missing === "sai2") {
            // precisa de ent1, sai1, ent2
            if (ent1 !== null && sai1 !== null && ent2 !== null) {
              // (sai1 - ent1) + (sai2 - ent2) = Work
              // => sai2 = Work - (sai1 - ent1) + ent2
              const manha = sai1 - ent1;
              const tarde = jornadaMin - manha;
              sai2 = ent2 + tarde;
            }
          }

          // Checa se conseguiu resolver
          if (
            (missing === "ent1" && ent1 === null) ||
            (missing === "sai1" && sai1 === null) ||
            (missing === "ent2" && ent2 === null) ||
            (missing === "sai2" && sai2 === null)
          ) {
            showMessage(
              "N√£o foi poss√≠vel calcular o hor√°rio em branco com os dados informados. Preencha mais um campo ou ajuste o almo√ßo.",
              true
            );
            return;
          }

          // Atualiza inputs com os valores calculados
          if (ent1 !== null) ent1Input.value = minutesToHHMM(ent1);
          if (sai1 !== null) sai1Input.value = minutesToHHMM(sai1);
          if (ent2 !== null) ent2Input.value = minutesToHHMM(ent2);
          if (sai2 !== null) sai2Input.value = minutesToHHMM(sai2);

          // Mostra resumo
          resumoCard.classList.remove("hidden");
          resumoTexto.innerHTML = `
            Jornada base: <strong>${minutesToHHMM(
              jornadaBaseMin
            )}</strong>, hora extra/banco: <strong>${minutesToSignedDuration(
            extraMin
          )}</strong>, jornada total: <strong>${minutesToHHMM(
            jornadaMin
          )}</strong>.<br>
            Almo√ßo considerado: <strong>${
              almocoMin !== null ? minutesToHHMM(almocoMin) : "n√£o definido"
            }</strong>.
          `;
          renderResumoHorarios();

          if (!msg.textContent) {
            showMessage(
              "Hor√°rio em branco calculado automaticamente para fechar a jornada.",
              false
            );
          }
          return; // n√£o segue para a l√≥gica antiga
        }

        // -------- CASOS GERAIS (mais de 1 em branco ou todos preenchidos) --------
        if (!ensureAlmoco()) return;

        // C√°lculo a partir da primeira entrada
        if (ent1 !== null) {
          if (sai1 === null && ent2 === null && sai2 === null) {
            // s√≥ ent1 -> divide jornada
            sai1 = ent1 + metadeJornada;
            ent2 = sai1 + almocoMin;
            sai2 = ent2 + metadeJornada;
          } else if (sai1 !== null && ent2 === null && sai2 === null) {
            const trabalhadoManha = sai1 - ent1;
            if (trabalhadoManha <= 0 || trabalhadoManha >= jornadaMin) {
              showMessage(
                "Hor√°rio da manh√£ inv√°lido em rela√ß√£o √† jornada total.",
                true
              );
              return;
            }
            const restante = jornadaMin - trabalhadoManha;
            ent2 = sai1 + almocoMin;
            sai2 = ent2 + restante;
          } else if (sai1 === null && ent2 !== null && sai2 !== null) {
            const trabalhadoTarde = sai2 - ent2;
            if (trabalhadoTarde <= 0 || trabalhadoTarde >= jornadaMin) {
              showMessage(
                "Hor√°rio da tarde inv√°lido em rela√ß√£o √† jornada total.",
                true
              );
              return;
            }
            const restante = jornadaMin - trabalhadoTarde;
            sai1 = ent1 + restante;
            if (ent2 - sai1 <= 0) {
              showMessage(
                "Intervalo entre manh√£ e tarde inv√°lido. Ajuste manualmente.",
                true
              );
              return;
            }
          } else {
            // caso misto: tenta manter ent1 e sai2 e ajeitar o meio
            if (ent1 !== null && sai2 !== null) {
              const totalPresenca = sai2 - ent1;
              const idealPresenca = jornadaMin + almocoMin;
              if (totalPresenca !== idealPresenca) {
                const manha = Math.floor(jornadaMin / 2);
                const tarde = jornadaMin - manha;
                sai1 = ent1 + manha;
                ent2 = sai1 + almocoMin;
                // sai2 fica como est√° (user fixou)
              }
            }
          }
        } else if (sai2 !== null) {
          // C√°lculo a partir da √∫ltima sa√≠da
          if (ent1 === null && sai1 === null && ent2 === null) {
            const manha = Math.floor(jornadaMin / 2);
            const tarde = jornadaMin - manha;
            ent2 = sai2 - tarde;
            sai1 = ent2 - almocoMin;
            ent1 = sai1 - manha;
          } else if (ent1 === null && sai1 !== null && ent2 !== null) {
            const trabalhadoTarde = sai2 - ent2;
            if (trabalhadoTarde <= 0 || trabalhadoTarde >= jornadaMin) {
              showMessage(
                "Hor√°rio da tarde inv√°lido em rela√ß√£o √† jornada total.",
                true
              );
              return;
            }
            const restante = jornadaMin - trabalhadoTarde;
            ent1 = sai1 - restante;
            if (ent2 - sai1 <= 0) {
              showMessage(
                "Intervalo entre manh√£ e tarde inv√°lido. Ajuste manualmente.",
                true
              );
              return;
            }
          } else {
            const manha = Math.floor(jornadaMin / 2);
            const tarde = jornadaMin - manha;
            ent2 = sai2 - tarde;
            sai1 = ent2 - almocoMin;
            ent1 = sai1 - manha;
          }
        }

        if (ent1 !== null) ent1Input.value = minutesToHHMM(ent1);
        if (sai1 !== null) sai1Input.value = minutesToHHMM(sai1);
        if (ent2 !== null) ent2Input.value = minutesToHHMM(ent2);
        if (sai2 !== null) sai2Input.value = minutesToHHMM(sai2);

        // Montar resumo
        resumoCard.classList.remove("hidden");
        resumoTexto.innerHTML = `
          Jornada base: <strong>${minutesToHHMM(
            jornadaBaseMin
          )}</strong>, hora extra/banco: <strong>${minutesToSignedDuration(
          extraMin
        )}</strong>, jornada total: <strong>${minutesToHHMM(
          jornadaMin
        )}</strong>.<br>
          Almo√ßo considerado: <strong>${
            almocoMin !== null ? minutesToHHMM(almocoMin) : "n√£o definido"
          }</strong>.
        `;
        renderResumoHorarios();

        if (!msg.textContent) {
          showMessage(
            "C√°lculo conclu√≠do. Confira o resumo abaixo. Se quiser, volte ao Passo 2 para ajustes finos.",
            false
          );
        }
      }

      // Navega√ß√£o entre passos
      btnNext1.addEventListener("click", () => {
        try {
          // Valida jornada
          getJornadaMinutes();

          // Se almo√ßo auto, e j√° tiver entrada/sa√≠da do dia, joga para a tabela
          if (isAlmocoAuto()) {
            const dEnt = diaEntradaInput.value;
            const dSai = diaSaidaInput.value;
            const rows = tbody.querySelectorAll("tr");
            if (rows.length >= 2) {
              const row1Ent = rows[0].querySelector(".entrada");
              const row2Sai = rows[1].querySelector(".saida");
              if (dEnt) row1Ent.value = dEnt;
              if (dSai) row2Sai.value = dSai;
            }
          }

          setStep(2);
        } catch (e) {
          alert(e.message);
        }
      });

      btnNext2.addEventListener("click", () => setStep(3));
      btnBack2.addEventListener("click", () => setStep(1));
      btnBack3.addEventListener("click", () => setStep(2));

      // Eventos principais
      btnAdicionar.addEventListener("click", adicionarLinha);
      btnCalcular.addEventListener("click", calcularAutomatico);
      btnLimpar.addEventListener("click", limparHorarios);

      // Delega√ß√£o para remover intervalos extras (a partir do 3¬∫)
      tbody.addEventListener("click", (event) => {
        const target = event.target;
        if (target.classList.contains("btn-remover")) {
          const linhas = Array.from(tbody.querySelectorAll("tr"));
          const tr = target.closest("tr");
          const index = linhas.indexOf(tr);
          if (index > 1) {
            tr.remove();
            renumerarLinhas();
          }
        }
      });
    </script>
  </body>
</html>
